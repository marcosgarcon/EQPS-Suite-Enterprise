
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EQPS Ultimate 5.0 - Panasonic Extrema</title>
    <meta name="theme-color" content="#020617">
    <link rel="manifest" href="manifest.json">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    
    <script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@^19.2.3",
    "react-dom": "https://esm.sh/react-dom@^19.2.3",
    "react-dom/client": "https://esm.sh/react-dom@^19.2.3/client",
    "lucide-react": "https://esm.sh/lucide-react@^0.562.0",
    "recharts": "https://esm.sh/recharts@^3.6.0",
    "@google/genai": "https://esm.sh/@google/genai@^1.34.0",
    "react-dom/": "https://esm.sh/react-dom@^19.2.3/",
    "react/": "https://esm.sh/react@^19.2.3/"
  }
}
</script>

    <style>
        :root { --sky-500: #0ea5e9; --bg-dark: #020617; }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-dark); color: #f8fafc; overflow: hidden; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #1e293b; border-radius: 10px; }
        .glass-panel { background: rgba(15, 23, 42, 0.7); backdrop-filter: blur(16px); border: 1px solid rgba(30, 41, 59, 0.5); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-in { animation: fadeIn 0.4s ease-out forwards; }
        @media print { .no-print { display: none !important; } body { background: white; color: black; overflow: visible; } }
        
        /* Botão de Instalação Floating */
        #pwa-install-btn {
            position: fixed;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            display: none;
            animation: bounce 2s infinite;
        }
        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% {transform: translateX(-50%) translateY(0);}
            40% {transform: translateX(-50%) translateY(-10px);}
            60% {transform: translateX(-50%) translateY(-5px);}
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <!-- Botão de Instalação PWA -->
    <div id="pwa-install-btn">
        <button onclick="installPWA()" class="px-8 py-4 bg-sky-500 text-slate-950 rounded-full font-black text-xs uppercase tracking-widest shadow-[0_0_30px_rgba(14,165,233,0.5)] flex items-center gap-3">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>
            Instalar App EQPS no Windows
        </button>
    </div>

    <script>
        // Registrar Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(reg => console.log('EQPS SW Registrado!'))
                    .catch(err => console.log('SW Erro:', err));
            });
        }

        // Lógica de Instalação
        let deferredPrompt;
        const installBtn = document.getElementById('pwa-install-btn');

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            installBtn.style.display = 'block';
        });

        async function installPWA() {
            if (!deferredPrompt) return;
            deferredPrompt.prompt();
            const { outcome } = await deferredPrompt.userChoice;
            if (outcome === 'accepted') {
                console.log('Usuário aceitou a instalação');
                installBtn.style.display = 'none';
            }
            deferredPrompt = null;
        }

        window.addEventListener('appinstalled', () => {
            installBtn.style.display = 'none';
            console.log('EQPS instalado com sucesso!');
        });
    </script>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import { 
            LayoutGrid, ChevronRight, ChevronDown, Folder, Database, Briefcase, Cpu, 
            FileSearch, Box, Binary, Settings, Rocket, Code2, GraduationCap, Activity, 
            FileCheck, Wrench, ShieldCheck, History, ClipboardCheck, Package, Layers, 
            FileText, Search, Sparkles, X, Send, Terminal as TerminalIcon, CheckCircle2,
            UploadCloud, FileDown, PlusCircle, Trash2, Save, Wand2, Dna, Image as ImageIcon,
            FileJson, Loader2, AlertCircle, AlertTriangle, Target, Clock, BookOpen, Award,
            ArrowLeft, Zap, ExternalLink, Monitor, User, Shield, Microscope
        } from 'lucide-react';
        import { 
            BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, 
            AreaChart, Area, Cell, LineChart, Line
        } from 'recharts';
        import { GoogleGenAI, Type } from '@google/genai';

        // --- SEGURANÇA AMBIENTE ---
        const HAS_KEY = typeof process !== 'undefined' && process.env && process.env.API_KEY;

        // --- CONFIGURAÇÕES ---
        const BUSINESS_UNITS = ['WM-Lavadoras', 'RF-Refrigerador', 'Qualidade', 'Manutenção'];
        const MODELS = ['W640', 'W600', 'B41', 'GERAL'];
        const DOC_TYPES = ['FITP', 'Desenhos', 'Cartas de Controle', 'Estoque', 'Checklist'];

        const INITIAL_DB = {
            kpis: {
                FPY: { key: 'FPY', name: 'FPY Global', category: 'Qualidade', target: 98, comparator: '>=', unit: '%' },
                OEE: { key: 'OEE', name: 'OEE Linha 01', category: 'Eficiência', target: 85, comparator: '>=', unit: '%' }
            },
            records: { FPY: [{ id: 1, date: '2024-05-20', value: 97.5 }] },
            courses: [],
            assets: [],
            controlCharts: []
        };

        const MOCK_EXTRACTED_POINTS = [
            { id: 'P1', label: 'Diâmetro Interno Cesto', nominal: 450.5, tolerancePlus: 0.5, toleranceMinus: 0.5 },
            { id: 'P2', label: 'Altura da Flange', nominal: 12.0, tolerancePlus: 0.2, toleranceMinus: 0.1 },
            { id: 'P3', label: 'Espessura da Chapa', nominal: 0.8, tolerancePlus: 0.05, toleranceMinus: 0.05 }
        ];

        // --- COMPONENTES ---

        const Sidebar = ({ onNavigate, currentView }) => {
            return (
                <div className="w-72 h-screen bg-[#020617] border-r border-slate-800/60 flex flex-col z-50 shadow-2xl no-print">
                    <div className="p-8 border-b border-slate-800/40 flex items-center gap-4">
                        <div className="bg-sky-500 p-2 rounded-2xl"><Database className="text-slate-900" size={20} /></div>
                        <div>
                            <h1 className="text-white font-black text-lg tracking-tighter uppercase leading-none">EQPS Suite</h1>
                            <p className="text-[9px] text-slate-600 uppercase font-black tracking-[0.2em]">Enterprise 5.0</p>
                        </div>
                    </div>
                    <div className="flex-1 overflow-y-auto p-4 custom-scrollbar">
                        <nav className="space-y-1">
                            <button onClick={() => onNavigate('dashboard')} className={`w-full flex items-center gap-3 px-4 py-3 rounded-2xl transition-all ${currentView === 'dashboard' ? 'bg-sky-500 text-slate-900 font-black' : 'hover:bg-slate-900 text-slate-400'}`}>
                                <LayoutGrid size={18} /> <span className="text-xs uppercase font-black">Dashboard</span>
                            </button>
                            <button onClick={() => onNavigate('quality-lab')} className={`w-full flex items-center gap-3 px-4 py-3 rounded-2xl transition-all ${currentView === 'quality-lab' ? 'bg-emerald-500 text-slate-900 font-black' : 'hover:bg-slate-900 text-slate-400'}`}>
                                <Microscope size={18} /> <span className="text-xs uppercase font-black">Laboratório CQ</span>
                            </button>
                            <button onClick={() => onNavigate('academy')} className={`w-full flex items-center gap-3 px-4 py-3 rounded-2xl transition-all ${currentView === 'academy' ? 'bg-amber-500 text-slate-900 font-black' : 'hover:bg-slate-900 text-slate-400'}`}>
                                <GraduationCap size={18} /> <span className="text-xs uppercase font-black">Academia</span>
                            </button>
                            <button onClick={() => onNavigate('config')} className={`w-full flex items-center gap-3 px-4 py-3 rounded-2xl transition-all ${currentView === 'config' ? 'bg-indigo-500 text-slate-900 font-black' : 'hover:bg-slate-900 text-slate-400'}`}>
                                <Settings size={18} /> <span className="text-xs uppercase font-black">Data Hub</span>
                            </button>
                        </nav>
                    </div>
                </div>
            );
        };

        const QualityLab = () => {
            const [file, setFile] = useState(null);
            const [base64, setBase64] = useState(null);
            const [loading, setLoading] = useState(false);
            const [points, setPoints] = useState([]);
            const [model, setModel] = useState('');

            const handleFileUpload = (e) => {
                const f = e.target.files[0];
                if (!f) return;
                setFile(f);
                const reader = new FileReader();
                reader.onload = (ev) => setBase64(ev.target.result.split(',')[1]);
                reader.readAsDataURL(f);
            };

            const extractData = async () => {
                if (!model) return;
                setLoading(true);

                if (!HAS_KEY) {
                    setTimeout(() => {
                        setPoints(MOCK_EXTRACTED_POINTS.map(p => ({ ...p, measured: null })));
                        setLoading(false);
                    }, 1500);
                    return;
                }

                const ai = new GoogleGenAI({ apiKey: process.env.API_KEY });
                try {
                    const response = await ai.models.generateContent({
                        model: 'gemini-3-flash-preview',
                        contents: {
                            parts: [
                                { text: `Analise esta carta de controle industrial para o modelo ${model}. Extraia os pontos de medição em JSON: id (P1, P2...), label (descrição), nominal (número), tolerancePlus (número), toleranceMinus (número).` },
                                { inlineData: { data: base64, mimeType: file.type } }
                            ]
                        },
                        config: {
                            responseMimeType: "application/json",
                            responseSchema: {
                                type: Type.ARRAY,
                                items: {
                                    type: Type.OBJECT,
                                    properties: {
                                        id: { type: Type.STRING },
                                        label: { type: Type.STRING },
                                        nominal: { type: Type.NUMBER },
                                        tolerancePlus: { type: Type.NUMBER },
                                        toleranceMinus: { type: Type.NUMBER }
                                    }
                                }
                            }
                        }
                    });
                    const data = JSON.parse(response.text);
                    setPoints(data.map(p => ({ ...p, measured: null })));
                } catch (e) { 
                    setPoints(MOCK_EXTRACTED_POINTS.map(p => ({ ...p, measured: null })));
                }
                setLoading(false);
            };

            const checkPoint = (p) => {
                if (p.measured === null || p.measured === "" || p.measured === undefined) return 'pending';
                const val = parseFloat(p.measured);
                return (val >= p.nominal - p.toleranceMinus && val <= p.nominal + p.tolerancePlus) ? 'pass' : 'fail';
            };

            return (
                <div className="space-y-10 animate-in">
                    <div className="glass-panel p-10 rounded-[3rem] flex flex-col md:flex-row justify-between items-center gap-8">
                        <div className="flex items-center gap-6">
                            <div className="w-16 h-16 bg-emerald-500 rounded-3xl flex items-center justify-center text-slate-900 shadow-xl"><Microscope size={32} /></div>
                            <div>
                                <h2 className="text-3xl font-black text-white uppercase tracking-tight">Laboratório CQ</h2>
                                <p className="text-xs text-slate-500 font-bold uppercase tracking-widest mt-1">
                                    {HAS_KEY ? "Extração Real via Gemini IA" : "Modo Demo de Simulação"}
                                </p>
                            </div>
                        </div>
                        <div className="flex gap-4">
                            <input value={model} onChange={e => setModel(e.target.value)} placeholder="Modelo (W640, B41...)" className="bg-slate-900 border border-slate-800 rounded-2xl px-6 py-4 text-xs text-white outline-none focus:border-emerald-500 w-48" />
                            <div onClick={() => document.getElementById('cqIn').click()} className="px-8 py-4 bg-slate-900 border border-slate-800 rounded-2xl font-black text-xs uppercase text-slate-400 cursor-pointer hover:text-white flex items-center gap-2">
                                <UploadCloud size={16} /> {file ? file.name : "Selecionar Documento"}
                            </div>
                            <input id="cqIn" type="file" className="hidden" onChange={handleFileUpload} />
                            <button onClick={extractData} disabled={loading || !model} className="px-8 py-4 bg-emerald-500 text-slate-950 rounded-2xl font-black text-xs uppercase hover:bg-emerald-400 disabled:opacity-20 transition-all flex items-center gap-2">
                                {loading ? <Loader2 className="animate-spin" size={16} /> : <Sparkles size={16} />} 
                                Analisar IA
                            </button>
                        </div>
                    </div>

                    {points.length > 0 && (
                        <div className="grid grid-cols-1 lg:grid-cols-12 gap-8">
                            <div className="lg:col-span-8 glass-panel p-10 rounded-[3rem] space-y-8">
                                <h3 className="text-sm font-black uppercase text-slate-500 tracking-widest border-b border-slate-800 pb-4">Checklist de Inspeção Dimensional - {model}</h3>
                                <div className="space-y-4">
                                    {points.map((p, i) => {
                                        const status = checkPoint(p);
                                        return (
                                            <div key={i} className="flex items-center justify-between p-6 bg-slate-900/50 rounded-2xl border border-slate-800">
                                                <div className="flex-1">
                                                    <p className="text-[10px] font-black text-emerald-500 uppercase">{p.id}</p>
                                                    <p className="text-sm font-black text-white uppercase">{p.label}</p>
                                                    <p className="text-[10px] text-slate-500 font-bold">Nominal: {p.nominal}mm (+{p.tolerancePlus} / -{p.toleranceMinus})</p>
                                                </div>
                                                <div className="flex items-center gap-4">
                                                    <input 
                                                        type="number" 
                                                        placeholder="Medido" 
                                                        className="w-24 bg-slate-950 border border-slate-800 rounded-xl px-4 py-3 text-xs text-white outline-none focus:border-emerald-500"
                                                        value={p.measured || ""}
                                                        onChange={(e) => {
                                                            const newPoints = [...points];
                                                            newPoints[i].measured = e.target.value;
                                                            setPoints(newPoints);
                                                        }}
                                                    />
                                                    {status === 'pass' && <CheckCircle2 className="text-emerald-500" size={24} />}
                                                    {status === 'fail' && <AlertCircle className="text-rose-500" size={24} />}
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                            <div className="lg:col-span-4 glass-panel p-10 rounded-[3rem] flex flex-col items-center justify-center text-center">
                                <Target className="text-emerald-500 mb-6" size={64} />
                                <h4 className="text-4xl font-black text-white">{points.filter(p => checkPoint(p) === 'pass').length}/{points.length}</h4>
                                <p className="text-[10px] font-black uppercase text-slate-500 mt-2">Conformidade do Lote</p>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const TelemetrySearchComp = () => {
            const [query, setQuery] = useState('');
            const [loading, setLoading] = useState(false);
            const [answer, setAnswer] = useState(null);

            const handleSearch = async (e) => {
                e.preventDefault();
                if (!query) return;
                setLoading(true);

                if (!HAS_KEY) {
                    setTimeout(() => {
                        setAnswer(`[MODO DEMO] A telemetria da Planta de Extrema indica que a linha WM-Lavadoras está operando com 94.1% de OEE. Não há alertas críticos de qualidade para o modelo W640 nas últimas 2 horas.`);
                        setLoading(false);
                    }, 1000);
                    return;
                }

                const ai = new GoogleGenAI({ apiKey: process.env.API_KEY });
                try {
                    const response = await ai.models.generateContent({
                        model: 'gemini-3-flash-preview',
                        contents: `Contexto: Planta Panasonic Extrema. Pergunta: ${query}`
                    });
                    setAnswer(response.text);
                } catch (e) { setAnswer("Erro na consulta."); }
                setLoading(false);
            };

            return (
                <div className="flex-1 max-w-2xl mx-12 relative">
                    <form onSubmit={handleSearch} className="relative group">
                        <div className="relative flex items-center bg-[#020617] border border-slate-800 rounded-2xl px-5 py-3 gap-4 focus-within:border-sky-500/50 transition-all">
                            <Search size={18} className="text-slate-500" />
                            <input 
                                type="text" 
                                placeholder="Perguntar ao Telemetry Engine (IA)..." 
                                className="bg-transparent border-none outline-none text-sm w-full text-slate-200 placeholder:text-slate-600 font-medium"
                                value={query}
                                onChange={e => setQuery(e.target.value)}
                            />
                            {loading ? <Loader2 className="animate-spin text-sky-400" size={18} /> : <Send onClick={handleSearch} size={18} className="text-slate-600 cursor-pointer hover:text-sky-400" />}
                        </div>
                    </form>
                    {answer && (
                        <div className="absolute top-full left-0 w-full mt-4 glass-panel p-6 rounded-3xl z-50 animate-in">
                            <div className="flex justify-between items-center mb-3">
                                <span className="text-[10px] font-black text-sky-400 uppercase tracking-widest flex items-center gap-2"><Sparkles size={12} /> Resposta IA</span>
                                <X onClick={() => setAnswer(null)} size={14} className="text-slate-600 cursor-pointer hover:text-white" />
                            </div>
                            <p className="text-xs text-slate-300 leading-relaxed">{answer}</p>
                        </div>
                    )}
                </div>
            );
        };

        const App = () => {
            const [db, setDb] = useState(() => {
                const saved = localStorage.getItem('eqps-v5-ultimate-db');
                return saved ? JSON.parse(saved) : INITIAL_DB;
            });
            const [view, setView] = useState('dashboard');

            useEffect(() => localStorage.setItem('eqps-v5-ultimate-db', JSON.stringify(db)), [db]);

            return (
                <div className="flex h-screen overflow-hidden">
                    <Sidebar onNavigate={setView} currentView={view} />
                    <div className="flex-1 flex flex-col h-screen overflow-hidden">
                        <header className="h-20 glass-panel border-b border-slate-800 flex items-center justify-between px-10 z-50 shrink-0">
                            <div className="flex items-center gap-6">
                                <ShieldCheck className="text-sky-500" size={24} />
                                <div>
                                    <h1 className="text-[10px] font-black uppercase text-slate-500 tracking-[0.3em]">Status Operacional</h1>
                                    <p className="text-xs font-black text-white uppercase flex items-center gap-2">
                                        Planta de Extrema / Hub Digital
                                        {!HAS_KEY && <span className="px-2 py-0.5 bg-amber-500 text-slate-950 text-[8px] rounded-full">DEMO</span>}
                                    </p>
                                </div>
                            </div>
                            
                            <TelemetrySearchComp />

                            <div className="flex items-center gap-4">
                                <button onClick={() => setView('dashboard')} className={`p-2.5 rounded-xl transition-all ${view === 'dashboard' ? 'bg-sky-500 text-slate-900' : 'bg-slate-900 text-slate-400 hover:text-white'}`}><LayoutGrid size={20} /></button>
                                <div className="w-10 h-10 rounded-2xl bg-sky-500 flex items-center justify-center text-[10px] font-black text-slate-950 border border-white/10 shadow-lg">AD</div>
                            </div>
                        </header>
                        <main className="flex-1 overflow-y-auto p-10 custom-scrollbar">
                            <div className="max-w-[1400px] mx-auto pb-40">
                                {view === 'dashboard' && (
                                    <div className="space-y-8 animate-in">
                                        <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
                                            <div className="lg:col-span-2 glass-panel p-10 rounded-[3rem] h-64 flex flex-col justify-between group hover:border-sky-500/50 transition-all">
                                                <h3 className="text-sm font-black uppercase text-slate-500 tracking-widest">OEE Global - Tempo Real</h3>
                                                <div className="flex items-end justify-between">
                                                    <span className="text-9xl font-black text-white tracking-tighter">94.1%</span>
                                                    <div className="px-6 py-2 bg-emerald-500/10 text-emerald-500 border border-emerald-500/20 rounded-full font-black text-xs uppercase tracking-widest flex items-center gap-2">
                                                        <span className="w-2 h-2 bg-emerald-500 rounded-full animate-ping"></span>
                                                        Estabilidade Industrial
                                                    </div>
                                                </div>
                                            </div>
                                            <div className="glass-panel p-10 rounded-[3rem] h-64 flex flex-col justify-between">
                                                <h3 className="text-sm font-black uppercase text-slate-500 tracking-widest">Ativos Detectados</h3>
                                                <div>
                                                    <p className="text-5xl font-black text-white">128</p>
                                                    <p className="text-[10px] text-slate-600 font-bold uppercase mt-2">Dispositivos em Malha</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                )}
                                {view === 'quality-lab' && <QualityLab />}
                                {view === 'academy' && (
                                    <div className="space-y-10 animate-in">
                                        <div className="glass-panel p-10 rounded-[3rem] text-center space-y-4">
                                            <GraduationCap size={64} className="mx-auto text-amber-500" />
                                            <h2 className="text-3xl font-black text-white uppercase">Portal de Conhecimento</h2>
                                            <p className="text-slate-500 font-medium">Cursos gerados dinamicamente via IA para a Planta de Extrema.</p>
                                        </div>
                                    </div>
                                )}
                                {view === 'config' && (
                                    <div className="glass-panel p-20 rounded-[3rem] text-center space-y-6">
                                        <Database size={64} className="mx-auto text-indigo-500" />
                                        <h2 className="text-2xl font-black text-white uppercase">Gerenciamento de Dados</h2>
                                        <p className="text-slate-500 max-w-md mx-auto">Configure aqui os endpoints de telemetria e o repositório central de documentos da intranet.</p>
                                        <button className="px-10 py-4 bg-indigo-500 text-slate-950 font-black rounded-2xl uppercase text-xs">Sincronizar Banco</button>
                                    </div>
                                )}
                            </div>
                        </main>
                    </div>
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
